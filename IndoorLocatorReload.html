<!DOCTYPE html>
<html lang="zh" xmlns="http://www.w3.org/1999/html">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>室内定位系统</title>
    <link rel="stylesheet" href="lib/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
<div id="fengMap"></div>
<!--操作按钮-->
<div class="operating">
    <button class="btn btn-default" id="manageHistoricalTrace">历史轨迹管理</button>
    <button class="btn btn-default" id="showHistoricalTrace" style="display: none">添加历史轨迹</button><br/>
    <button class="btn btn-default" id="deleteHistoricalTrace" style="display: none">删除历史轨迹</button>
</div>

<div id="tagsInfo" style="position: absolute; left: 2%; top: 10%; display: none">
    <a href="javascript:void(0)" onclick="alert('定位标签267')">定位标签267   </a><input type="checkbox" id="checkBox1"/><br/><br/>
    <a href="javascript:void(0)" onclick="alert('定位标签158')">定位标签158   </a><input type="checkbox" id="checkBox2"/><br/><br/>
    <a href="javascript:void(0)" onclick="alert('定位标签5FB')">定位标签5FB   </a><input type="checkbox" id="checkBox3"/><br/><br/>
    <a href="javascript:void(0)" onclick="alert('定位标签273')">定位标签273   </a><input type="checkbox" id="checkBox4"/><br/><br/>
    <a href="javascript:void(0)" onclick="alert('定位标签5E5')">定位标签5E5   </a><input type="checkbox" id="checkBox5"/>
</div>

<div style="position: absolute; left: 2%; top: 2%;">
    <button class="btn btn-default" id="tagsManage">定位标签管理</button>
</div>

<div id="RailingInfo" style="position: absolute; left: 12%; top: 17%; display: none">
</div>

<div class="operating2">
    <button class="btn btn-default" id="railingManage" style="display: block">电子围栏管理</button>
    <button class="btn btn-default" id="addRailing" style="display: none">添加电子围栏</button>
    <button class="btn btn-default" id="YesaddRailing" style="display: none">确定</button>
    <button class="btn btn-default" id="NoaddRailing" style="display: none">取消</button>
</div>

<div style="position: absolute; left: 32%; top: 2%;">
    <button class="btn btn-default" id="HeatMap" style="display: block">显示数据热力图</button>
</div>

<audio src="sound/8858.wav" id="myaudio"></audio>
<div style="position: absolute; right: 0%; bottom: 0%;">
    <img src="image/TsingHuaLogo.png" width="135.333" height="64.667">
</div>
<div style="position: absolute; left: 41.5%; top: 2.6%;">
    <input type="text" id="datetime">
</div>

<script src="lib/jquery-2.1.4.min.js"></script>
<script src="lib/fengmap.min.js"></script>
<script src="js/laydate/laydate.js"></script>
<script>
    //获取版本号,设置title
    document.title = '室内定位系统';

    //定义全局map变量
    var map;
    var fmapID = 'qh-test';
    var count = 0;
    var locationMarker = null;
    var defaultGroupID = 1;
    var webSocketTest;
    var api_token;
    var resultJSON;
    var mLocationMaker;
    var isAdded;
    var myDate = new Date();

    //webSocket
    var webSocket0;
    var webSocket1;
    var webSocket2;
    var webSocket3;
    var webSocket4;

    //历史轨迹
    var mPoints = [];
    var isShown = false;
    var isHistoricalButtonShown = false;

    //电子围栏
    var isAddingRailing = false;
    var RailingPoints = [];
    var group;
    var layer;
    var railingMarker = [];
    var railingMarkerPoints = [];
    var railingId = [];
    var railingDeleteId = [];
    var uploadPoints;
    var isRailingInfoShown = false;

    var wasInRailing = [false, false, false, false, false];
    var isRailingEnabled = [];

    //Notification
    var myAudio;

    //热力图实例
    var heatmapInstance = null;
    var dataHeatmap = false;
    var groupLayer;
    var hYear = myDate.getFullYear();
    var hMon = (myDate.getMonth()+1);
    var hDay = myDate.getDate();
    var hHour = myDate.getHours();
    var hMin = myDate.getMinutes();
    var hSec = myDate.getSeconds();


    $(function() {
        map = new fengmap.FMMap({
            //渲染dom
            container: document.getElementById('fengMap'),
            //地图数据位置
            mapServerURL: './data/' + fmapID,
            //主题数据位置
            mapThemeURL: 'data/theme',
            //设置主题
            defaultThemeName: '4003',
            // 默认比例尺级别设置为20级
            defaultMapScaleLevel: 22,
            //开发者申请应用下web服务的key
            key: 'f85f77f2ea2245420152dcb87b6c3180',
            //开发者申请应用名称
            appName: 'UWBWebIndoorLocator',
        });

        //打开Fengmap服务器的地图数据和主题
        map.openMapById(fmapID);

        //地图加载完成事件
        map.on('loadComplete', function() {

            myAudio = document.getElementById("myaudio");

            //获取第一层
            group = map.getFMGroup(map.groupIDs[0]);

            //返回当前层中第一个polygonMarker,如果没有，则自动创建
            layer = group.getOrCreateLayer('polygonMarker');

            API_TOKEN();

            //添加定位点标注，并设置定位点坐标为地图中心点
            map.rotateTo({
                to: 0,           //设置角度
                duration: .3,      //动画持续时间，默认为。3秒
            });

            //创建楼层(按钮型)，创建时请在地图加载后(loadComplete回调)创建。
            //不带单/双层楼层控制按钮,初始时只有1个按钮,点击后可弹出其他楼层按钮
            groupControl = new fengmap.buttonGroupsControl(map, ctlOpt);

            //保持多层和楼层切换一致
            groupControl.onChange(function(groups, allLayer) {
                //groups 表示当前要切换的楼层ID数组,
                //allLayer表示当前楼层是单层状态还是多层状态。
            });

            //楼层控件是否可点击，默认为true
            groupControl.enableExpand = true;

            var toolControl = new fengmap.toolControl(map, {
                //初始化2D模式
                init2D: false,
                //设置为false表示只显示2D,3D切换按钮
                groupsButtonNeeded: false,
                //点击按钮的回调方法,返回type表示按钮类型,value表示对应的功能值

                position: fengmap.controlPositon.RIGHT_BOTTOM,

                offset: {
                    x: 70,
                    y: 0
                },

                clickCallBack: function(type, value) {
                    // console.log(type,value);
                }
            });

            initLocationMarker();

        });

        map.on('mapClickNode', function(event) {
            if(event.nodeType === 5||event.nodeType === 4) {
                if (isAddingRailing) {
                    RailingPoints.push({
                        x: event.eventInfo.coord.x,
                        y: event.eventInfo.coord.y,
                        z: 0
                    });
                    if (RailingPoints.length === 3) {
                        polygonMarker = new fengmap.FMPolygonMarker({
                            //设置颜色
                            color: '#4169E1',
                            //设置透明度
                            alpha: .5,
                            //设置边框线的宽度
                            lineWidth: 3,
                            //设置高度
                            height: 3,
                            //设置电子围栏的坐标点
                            points: RailingPoints
                        });
                        layer.addMarker(polygonMarker);
                    } else if (RailingPoints.length > 3) {
                        layer.removeMarker(polygonMarker);
                        polygonMarker = new fengmap.FMPolygonMarker({
                            //设置颜色
                            color: '#4169E1',
                            //设置透明度
                            alpha: .5,
                            //设置边框线的宽度
                            lineWidth: 3,
                            //设置高度
                            height: 6,
                            //设置电子围栏的坐标点
                            points: RailingPoints
                        });
                        layer.addMarker(polygonMarker);
                    }
                }
            }
        });

        function initWebSocket (webSocketTemp,num) {
            webSocketTemp.onopen = function() {
                console.log("open");
            };
            console.log(webSocketTemp.readyState);
            webSocketTemp.onmessage = function (event) {
                console.log(event.data);
                var data = JSON.parse(event.data);

                if(data.msgType === 'coord') {
                    if(!isAdded[num]) {
                        map.addLocationMarker(mLocationMaker[num])
                    }
                    mLocationMaker[num].x = data.x/100+map.minX;
                    mLocationMaker[num].y = map.maxY-data.y/100;
                    isContained({
                        x: data.x/100+map.minX,
                        y: map.maxY-data.y/100,
                        z: 0});
                } else if(data.msgType === 'fenceAlert') {

                }
                
            };
            webSocketTemp.onclose = function() {
                console.log("close");
                map.removeLocationMarker(mLocationMaker[num]);
                isAdded[num] = false;
            };
            webSocketTemp.onerror = function() {
                console.log("error");
            };
        }

        function API_TOKEN () {
            $.ajax({
                type: 'POST',
                url: "http://track.ubitraq.com:8082/user/login",
                contentType: "application/json;charset=utf-8",
                data: JSON.stringify({"loginCode": "qhnyadmin", "loginPwd": "qhnyadmin"}),
                dataType: "text",
                success: function (result) {
                    //window.alert(result.toString());
                    resultJSON = $.parseJSON(result.toString());
                    api_token = resultJSON.entity.api_token;

                    initSignalMarker();
                    initRailing();
                },
                error: function (msg) {
                    window.alert(msg);
                }
            });
        }

        function initSignalMarker() {
            $.ajax({
                type: 'GET',
                headers: {"api_token": api_token},
                url: "http://track.ubitraq.com:8082/project/anchor/list",
               success: function (result) {
                    for (var i = 0; i < result.length; i++) {
                        var signalMarker = new fengmap.FMLocationMarker({
                            url: 'image/signal.png',
                            //设置图片显示尺寸
                            size: 36,
                            //设置图片高度，默认是5
                            height: 0,
                        });
                        map.addLocationMarker(signalMarker);
                        signalMarker.x = result[i].x/100 + map.minX;
                        signalMarker.y = map.maxY - result[i].y/100;
                    }
                },
                error: function (msg) {
                    window.alert(msg);
                }
            });
        }

        function initLocationMarker() {
            mLocationMaker = [
                new fengmap.FMLocationMarker({url: 'image/point2.png', size: 30, height: 0}),
                new fengmap.FMLocationMarker({url: 'image/point2.png', size: 30, height: 0}),
                new fengmap.FMLocationMarker({url: 'image/point2.png', size: 30, height: 0}),
                new fengmap.FMLocationMarker({url: 'image/point2.png', size: 30, height: 0}),
                new fengmap.FMLocationMarker({url: 'image/point2.png', size: 30, height: 0})
            ]
            isAdded = [false,false,false,false,false];
        }
        //创建定位点标注
        function addLocationMarker(coord) {
            locationMarker = new fengmap.FMLocationMarker({
                url: 'image/point2.png',
                //设置图片显示尺寸
                size: 30,
                //设置图片高度，默认是5
                height: 10,
                callback: function() {
                    // 设置LocationMarker的，初始方向
                    locationMarker.direction = -90;
                }
            });

            map.addLocationMarker(locationMarker);

            /*locationMarker.setPosition({
                //设置定位点的x坐标
                x: coord.x,
                //设置定位点的y坐标
                y: coord.y,
                //设置定位点所在楼层
                groupID: defaultGroupID,
                //设置定位点的高于楼层多少
                zOffset: 1,
            });*/
        };
        function alertTest() {
            window.alert("yesClick");
        }

        //移动的方法
        function moveTo(coord) {
            //改变locMarker的x值
            locationMarker.x = coord.x;
            //改变locMarker的y值
            locationMarker.y = coord.y;
            /*map.moveTo({
                //改变中心点x的位置
                x: coord.x,
                //改变中心点y的位置
                y: coord.y,
                //默认时间是0.3秒
                time: 1,
                callback: function() {
                    // console.log('moveTo Complete!');
                }
            });*/
        };

        //楼层控制控件配置参数
        var ctlOpt = new fengmap.controlOptions({
            //默认在右下角
            position: fengmap.controlPositon.RIGHT_BOTTOM,
            //默认显示楼层的个数
            showBtnCount: 7,
            //位置x,y的偏移量
            offset: {
                x: 20,
                y: 0
            }
        });

        //var webSocketTest = newWebSocket();
        //var loginInfo = {"loginCode":"qhnyadmin","loginPwd":"qhnyadmin"};

        $("#checkBox1").on('click',function() {
            if(this.checked) {
                var stamp = new Date().getTime();
                webSocket0 = new WebSocket("ws://track.ubitraq.com:8083/websocket/tag_00000267_2d" + stamp + api_token);
                initWebSocket(webSocket0,0);
                if(isAdded[0] === false) {
                    map.addLocationMarker(mLocationMaker[0]);
                    isAdded[0] = true;
                }
                mLocationMaker[0].x = map.center.x;
                mLocationMaker[0].y = map.center.y;
            } else {
                webSocket0.close();
            }
        });
        $("#checkBox2").on('click',function() {
            if(this.checked) {
                var stamp = new Date().getTime();
                webSocket1 = new WebSocket("ws://track.ubitraq.com:8083/websocket/tag_00000158_2d" + stamp + api_token);
                initWebSocket(webSocket1,1);
                if(isAdded[1] === false) {
                    map.addLocationMarker(mLocationMaker[1]);
                    isAdded[1] = true;
                }
                mLocationMaker[1].x = map.center.x;
                mLocationMaker[1].y = map.center.y;

            } else {
                webSocket1.close();
            }
        });
        $("#checkBox3").on('click',function() {
            if(this.checked) {
                var stamp = new Date().getTime();
                webSocket2 = new WebSocket("ws://track.ubitraq.com:8083/websocket/tag_000005fb_2d" + stamp + api_token);
                initWebSocket(webSocket2,2);
                if(isAdded[2] === false) {
                    map.addLocationMarker(mLocationMaker[2]);
                    isAdded[2] = true;
                }
                mLocationMaker[2].x = map.center.x;
                mLocationMaker[2].y = map.center.y;

            } else {
                webSocket2.close();
            }
        });
        $("#checkBox4").on('click',function() {
            if(this.checked) {
                var stamp = new Date().getTime();
                webSocket3 = new WebSocket("ws://track.ubitraq.com:8083/websocket/tag_00000273_2d" + stamp + api_token);
                initWebSocket(webSocket3,3);
                if(isAdded[3] === false) {
                    map.addLocationMarker(mLocationMaker[3]);
                    isAdded[3] = true;
                }
                mLocationMaker[3].x = map.center.x;
                mLocationMaker[3].y = map.center.y;

            } else {
                webSocket3.close();
            }
        });
        $("#checkBox5").on('click',function() {
            if(this.checked) {
                var stamp = new Date().getTime();
                webSocket4 = new WebSocket("ws://track.ubitraq.com:8083/websocket/tag_000005e5_2d" + stamp + api_token);
                initWebSocket(webSocket4,4);
                if(isAdded[4] === false) {
                    map.addLocationMarker(mLocationMaker[4]);
                    isAdded[4] = true;
                }
                mLocationMaker[4].x = map.center.x;
                mLocationMaker[4].y = map.center.y;

            } else {
                webSocket4.close();
            }
        });

        //绘制线图层
        function drawLines(results) {
            //绘制部分
            //配置线型、线宽、透明度等
            var lineStyle = {
                //设置线的宽度
                lineWidth: 4,
                //设置线的透明度
                alpha: 0.8,
                //设置线的类型为导航线
                lineType: fengmap.FMLineType.FMARROW,
                //设置线动画,false为动画
                noAnimate: true,
            };
            var line = new fengmap.FMLineMarker();
            var seg = new fengmap.FMSegment();
            seg.groupId = 1;
            seg.points = results;
            line.addSegment(seg);
            map.drawLineMark(line, lineStyle);
        };

        //显示历史轨迹
        $("#showHistoricalTrace").on('click', function() {

            var time = "&start=" + myDate.getFullYear() + "-" + (myDate.getMonth()+1) + "-" + myDate.getDate() + "+" + myDate.getHours() + "%3A" + (myDate.getMinutes()-1) + "%3A" + myDate.getSeconds() + "&end=" + myDate.getFullYear() + "-" + (myDate.getMonth()+1) + "-" + myDate.getDate() + "+" + myDate.getHours() + "%3A" + myDate.getMinutes() + "%3A" + myDate.getSeconds();

            console.log(1,"http://track.ubitraq.com:8082/history/list?mapId=4&tagMacs%5B%5D=" + "00000267" + time);
            if (document.getElementById("checkBox1").checked) {
                $.ajax({
                    type: 'GET',
                    headers: {"api_token": api_token},
                    url: "http://track.ubitraq.com:8082/history/list?mapId=4&tagMacs%5B%5D=" + "00000267" + time,
                    success: function (result) {
                        //window.alert(result.toString());
                        var pathlength = result["595"].paths.length;
                        for (var i = 0; i < pathlength; i++) {
                            var tempLocation = {
                                x: result["595"].paths[i].x / 100 + map.minX,
                                y: map.maxY - result["595"].paths[i].y / 100,
                                z: 0
                            };
                            mPoints.push(tempLocation);
                        }
                        drawLines(mPoints);
                    },
                    error: function (msg) {
                        window.alert(msg);
                    }
                });
            }
            if (document.getElementById("checkBox2").checked) {
                $.ajax({
                    type: 'GET',
                    headers: {"api_token": api_token},
                    url: "http://track.ubitraq.com:8082/history/list?mapId=4&tagMacs%5B%5D=" + "00000158" + time,
                    success: function (result) {
                        //window.alert(result.toString());
                        var pathlength = result["101"].paths.length;
                        for (var i = 0; i < pathlength; i++) {
                            var tempLocation = {
                                x: result["101"].paths[i].x / 100 + map.minX,
                                y: map.maxY - result["101"].paths[i].y / 100,
                                z: 0
                            };
                            mPoints.push(tempLocation);
                        }
                        drawLines(mPoints);
                    },
                    error: function (msg) {
                        window.alert(msg);
                    }
                });
            }
            if (document.getElementById("checkBox3").checked) {
                $.ajax({
                    type: 'GET',
                    headers: {"api_token": api_token},
                    url: "http://track.ubitraq.com:8082/history/list?mapId=4&tagMacs%5B%5D=" + "000005fb" + time,
                    success: function (result) {
                        //window.alert(result.toString());
                        var pathlength = result["1152"].paths.length;
                        for (var i = 0; i < pathlength; i++) {
                            var tempLocation = {
                                x: result["1152"].paths[i].x / 100 + map.minX,
                                y: map.maxY - result["1152"].paths[i].y / 100,
                                z: 0
                            };
                            mPoints.push(tempLocation);
                        }
                        drawLines(mPoints);
                    },
                    error: function (msg) {
                        window.alert(msg);
                    }
                });
            }
            if (document.getElementById("checkBox4").checked) {
                $.ajax({
                    type: 'GET',
                    headers: {"api_token": api_token},
                    url: "http://track.ubitraq.com:8082/history/list?mapId=4&tagMacs%5B%5D=" + "00000273" + time,
                    success: function (result) {
                        //window.alert(result.toString());
                        var pathlength = result["597"].paths.length;
                        for (var i = 0; i < pathlength; i++) {
                            var tempLocation = {
                                x: result["597"].paths[i].x / 100 + map.minX,
                                y: map.maxY - result["597"].paths[i].y / 100,
                                z: 0
                            };
                            mPoints.push(tempLocation);
                        }
                        drawLines(mPoints);
                    },
                    error: function (msg) {
                        window.alert(msg);
                    }
                });
            }
            if (document.getElementById("checkBox5").checked) {
                $.ajax({
                    type: 'GET',
                    headers: {"api_token": api_token},
                    url: "http://track.ubitraq.com:8082/history/list?mapId=4&tagMacs%5B%5D=" + "000005e5" + time,
                    success: function (result) {
                        //window.alert(result.toString());
                        var pathlength = result["1153"].paths.length;
                        for (var i = 0; i < pathlength; i++) {
                            var tempLocation = {
                                x: result["1153"].paths[i].x / 100 + map.minX,
                                y: map.maxY - result["1153"].paths[i].y / 100,
                                z: 0
                            };
                            mPoints.push(tempLocation);
                        }
                        drawLines(mPoints);
                    },
                    error: function (msg) {
                        window.alert(msg);
                    }
                });
            }
        });

        $("#deleteHistoricalTrace").on('click', function() {
            map.clearLineMark();
        });

        $("#tagsManage").on('click', function() {
            if(isShown) {
                document.getElementById("tagsInfo").style.display = 'none';
                document.getElementById("tagsManage").style.outline = 'none';
                document.getElementById("tagsManage").style.boxShadow = 'none';

                isShown = false;
            } else {
                document.getElementById("tagsInfo").style.display = 'block';
                document.getElementById("tagsManage").style.outline = 'none';
                document.getElementById("tagsManage").style.boxShadow = 'none';

                isShown = true;
            }
        });

        function initRailing() {

            $.ajax({
                type: 'GET',
                headers: {"api_token": api_token},
                url: "http://track.ubitraq.com:8082/fence/list?mapId=4",
                success: function (result) {

                    for(var i=0; i<result.length; i++) {

                        var pointArr = result[i].points.split(",");
                        for(var j=0; j<pointArr.length; j++) {
                            var loc = pointArr[j].split(" ");
                            railingMarkerPoints.push({
                                x: loc[0]/100 + map.minX,
                                y: map.maxY - loc[1]/100,
                                z: 0
                            });
                        }

                        railingMarker[i] = new fengmap.FMPolygonMarker({
                            //设置颜色
                            color: '#4169E1',
                            //设置透明度
                            alpha: .5,
                            //设置边框线的宽度
                            lineWidth: 3,
                            //设置高度
                            height: 3,
                            //设置电子围栏的坐标点
                            points: railingMarkerPoints
                        });

                        railingDeleteId[i] = result[i].id;

                        var oCheckbox=document.createElement("input");
                        var oButton=document.createElement("input");
                        var br=document.createElement("br");
                        var br1=document.createElement("br");
                        var myText=document.createTextNode(result[i].cname);
                        oCheckbox.setAttribute("type","checkbox");
                        oCheckbox.setAttribute("id",result[i].cname);
                        oButton.setAttribute("type","button");
                        oButton.setAttribute("value","x");
                        oButton.setAttribute("id","btn"+result[i].cname);
                        oButton.style.width="21px";
                        oButton.style.height="21px";
                        oButton.style.left="17%";
                        var mydiv=document.getElementById("RailingInfo");
                        mydiv.appendChild(oCheckbox);
                        mydiv.appendChild(myText);
                        mydiv.appendChild(oButton);
                        mydiv.appendChild(br);
                        mydiv.appendChild(br1);
                        railingId[i] = result[i].cname;
                        isRailingEnabled[i] = false;

                        /*var num = i;


                        $("#" + railingId[num]).on('click', function () {

                            console.log("test",railingId[0]);

                            if (this.checked) {

                                layer.addMarker(railingMarker[num]);

                                console.log(num, railingMarker[num]);

                            } else {
                                layer.removeMarker(railingMarker[num]);

                                railingMarker[num] = new fengmap.FMPolygonMarker({
                                    //设置颜色
                                    color: '#4169E1',
                                    //设置透明度
                                    alpha: .5,
                                    //设置边框线的宽度
                                    lineWidth: 3,
                                    //设置高度
                                    height: 3,
                                    //设置电子围栏的坐标点
                                    points: railingMarker[num].points
                                });

                                console.log(num, railingMarker[num]);
                            }
                        });*/

                        railingMarkerPoints = [];

                        if(i === result.length-1) {
                            initRailingCheckBox();
                            initRailingDeleteButton();
                        }
                    }

                },
                error: function (msg) {
                    window.alert(msg);
                }
            });
        }

        function initRailingCheckBox() {

            for(var k=0; k<railingId.length; k++) {

                (function(k) {

                    var num = k;

                    document.getElementById(railingId[k]).onclick = function () {

                        if (this.checked) {

                            layer.addMarker(railingMarker[num]);

                            console.log(num, railingMarker[num]);

                            isRailingEnabled[num] = true;

                        } else {
                            layer.removeMarker(railingMarker[num]);

                            railingMarker[num] = new fengmap.FMPolygonMarker({
                                //设置颜色
                                color: '#4169E1',
                                //设置透明度
                                alpha: .5,
                                //设置边框线的宽度
                                lineWidth: 3,
                                //设置高度
                                height: 3,
                                //设置电子围栏的坐标点
                                points: railingMarker[num].points
                            });

                            isRailingEnabled[num] = false;

                            console.log(num, railingMarker[num]);
                        }
                    };
                }) (k);
            }
        }

        function initRailingDeleteButton() {
            for(var k=0; k<railingId.length; k++) {

                (function (k) {

                    var num = k;

                    document.getElementById("btn"+railingId[num]).onclick = function () {
                        var r=confirm("确认删除电子围栏"+railingId[num]+"吗？");
                        if(r) {
                            $.ajax({
                                type: 'POST',
                                headers: {"api_token": api_token},
                                url: "http://track.ubitraq.com:8082/model/delete",
                                data: JSON.stringify({
                                    "model": "fence",
                                    "id": railingDeleteId[num]
                                }),
                                contentType: "application/json; charset=utf-8",
                                success: function (result) {
                                    if(result.isOk) {
                                        window.alert("删除电子围栏成功！");
                                        location.reload();
                                    } else {
                                        window.alert("删除电子围栏失败！");
                                    }
                                },
                                error: function (msg) {
                                    window.alert(msg);
                                }
                            });
                        }
                    }
                })(k)
            }
        }

        $("#addRailing").on('click', function(){
            document.getElementById("addRailing").style.display = 'none';
            document.getElementById("YesaddRailing").style.display = 'inline';
            document.getElementById("NoaddRailing").style.display = 'inline';

            isAddingRailing = true;
            RailingPoints = [];
        });

        $("#YesaddRailing").on('click', function(){
            isAddingRailing = false;
            if(RailingPoints.length < 3) {
                window.alert("添加电子围栏失败！");
            } else {
                layer.removeMarker(polygonMarker);
                var railingName = prompt("请输入电子围栏名称", "");
                if (railingName !== null) {
                    if(railingId.indexOf(railingName) !== -1) {
                        window.alert("电子围栏名称重复");
                    } else {

                        uploadPoints = "";
                        for(var i=0; i<RailingPoints.length; i++) {
                            uploadPoints += ((RailingPoints[i].x-map.minX)*100)+" "+((map.maxY-RailingPoints[i].y)*100);
                            if(RailingPoints.length !== i+1) {
                                uploadPoints += ",";
                            }
                        }

                        $.ajax({
                            type: 'POST',
                            headers: {"api_token": api_token},
                            url: "http://track.ubitraq.com:8082/fence/add",
                            data: JSON.stringify({"cname": railingName, "points": uploadPoints, "ftypeId": 2, "mapId": 4}),
                            contentType: "application/json; charset=utf-8",
                            success: function (result) {
                                if(result.isOk) {
                                    window.alert("添加电子围栏成功！");
                                    location.reload();
                                } else {
                                    window.alert("添加电子围栏失败！");
                                }
                            },
                            error: function (msg) {
                                window.alert(msg);
                            }
                        });
                    }
                }
            }

            document.getElementById("addRailing").style.display = 'inline';
            document.getElementById("YesaddRailing").style.display = 'none';
            document.getElementById("NoaddRailing").style.display = 'none';

        });

        $("#NoaddRailing").on('click', function(){
            isAddingRailing = false;
            if(RailingPoints.length > 2) {
                layer.removeMarker(polygonMarker);
            }

            document.getElementById("addRailing").style.display = 'inline';
            document.getElementById("YesaddRailing").style.display = 'none';
            document.getElementById("NoaddRailing").style.display = 'none';

        });

        $("#railingManage").on('click', function(){
            if(isRailingInfoShown) {
                document.getElementById("RailingInfo").style.display = 'none';
                document.getElementById("addRailing").style.display = 'none';
                document.getElementById("YesaddRailing").style.display = 'none';
                document.getElementById("NoaddRailing").style.display = 'none';

                isRailingInfoShown = false;
            } else {
                if(isAddingRailing) {
                    document.getElementById("YesaddRailing").style.display = 'inline';
                    document.getElementById("NoaddRailing").style.display = 'inline';
                } else {
                    document.getElementById("addRailing").style.display = 'inline';
                }

                document.getElementById("RailingInfo").style.display = 'inline';

                isRailingInfoShown = true;
            }
        });

        $("#manageHistoricalTrace").on('click', function(){
            if(isHistoricalButtonShown) {
                document.getElementById("showHistoricalTrace").style.display = 'none';
                document.getElementById("deleteHistoricalTrace").style.display = 'none';

                isHistoricalButtonShown = false;
            } else {
                document.getElementById("showHistoricalTrace").style.display = 'inline';
                document.getElementById("deleteHistoricalTrace").style.display = 'inline';

                isHistoricalButtonShown = true;
            }
        });

        function isContained(p) {
            for(var i=0; i<railingMarker.length; i++) {
                if(isRailingEnabled[i]) {
                    if (railingMarker.contain(p)) {
                        if (!wasInRailing[i]) {
                            myAudio.play();
                            Notification.requestPermission(function (permission) {
                                var notification = new Notification('Here I am!', {
                                    body: "定位标签进入电子围栏",
                                    icon: 'https://cdn2.iconfinder.com/data/icons/ios-7-style-metro-ui-icons/512/MetroUI_HTML5.png',
                                    dir: 'auto'
                                });
                            });
                            wasInRailing[i] = true;
                        }
                    } else if(wasInRailing[i]) {
                        myAudio.play();
                        Notification.requestPermission(function (permission) {
                            var notification = new Notification('Here I am!', {
                                body: "定位标签离开电子围栏",
                                icon: 'https://cdn2.iconfinder.com/data/icons/ios-7-style-metro-ui-icons/512/MetroUI_HTML5.png',
                                dir: 'auto'
                            });
                        });
                        wasInRailing[i] = false;
                    }
                }
            }
        }

        function addRailing() {

        }

        //执行一个laydate实例
        laydate.render({
            elem: '#datetime'
            ,type: 'datetime'
            ,theme: '#53cbd1'
            ,done: function(value, date, endDate){
                hYear = date.year;
                hMon = date.month;
                hDay = date.date;
                hHour = date.hours;
                hMin = date.minutes;
                hSec = date.seconds;
            }
            ,value: myDate.getFullYear() + '-' + '0' + (myDate.getMonth()+1) +  '-' + myDate.getDate() + ' ' +  myDate.getHours() + ':' + myDate.getMinutes() + ':' + myDate.getSeconds()
        });

        //添加热力图
        function createDtataHeatmap(map, groupID, data) {
            // 创建热力图对象
            if (!heatmapInstance) heatmapInstance = fengmap.FMHeatMap.create(map, {
                //热点半径
                radius: 9,
                //热力图透明度
                opacity: .7,
                //热力点value的最大值
                max: 50,
                //渐变色值，可配置
                // gradient:{ 0.45: "rgb(201,135,255)", 0.55: "rgb(189,97,255)", 0.65: "rgb(155,49,255)", 0.95: "yellow", 1.0: "rgb(157,53,255)" }
            });

            var heatmapPoints = data;
            //移除热力点
            heatmapInstance.clearPoints();
            heatmapInstance.addPoints(data);

            //热力图应用到哪一楼层
            groupLayer = map.getFMGroup(groupID);
            groupLayer.applyHeatMap(heatmapInstance);
            return;
        };

        //移除热力图
        function removeHeatmap() {
            groupLayer = map.getFMGroup(map.focusGroupID);
            groupLayer.removeHeatMap(heatmapInstance);
        }

        $("#HeatMap").on('click', function(){
            var i = 0;
            var getDate = false;
            var hPoints = [];
            var time = "&start=" + hYear + "-" + hMon + "-" + hDay + "+" + hHour + "%3A" + (hMin - 1) + "%3A" + hSec + "&end=" + hYear + "-" + hMon + "-" + hDay + "+" + hHour + "%3A" + hMin + "%3A" + hSec;
            dataHeatmap = !dataHeatmap;
            console.log(time);
            if (dataHeatmap) {
                $.ajax({
                    type: 'GET',
                    headers: {"api_token": api_token},
                    url: "http://track.ubitraq.com:8082/history/list?mapId=4&tagMacs%5B%5D=" + "00000158" + time,
                    async:false,
                    success: function (result) {
                        var tempLocation = {};
                        if(JSON.stringify(result) != "{}") {
                            var pathlength = result["101"].paths.length;
                            tempLocation = {
                                x: result["101"].paths[pathlength - 1].x / 100 + map.minX,
                                y: map.maxY - result["101"].paths[pathlength - 1].y / 100,
                                value: 50
                            };
                            i++;
                        }
                        hPoints.push(tempLocation);
                    },
                    error: function (msg) {
                        window.alert(msg);
                    }
                });
                $.ajax({
                    type: 'GET',
                    headers: {"api_token": api_token},
                    url: "http://track.ubitraq.com:8082/history/list?mapId=4&tagMacs%5B%5D=" + "000005fb" + time,
                    async:false,
                    success: function (result) {
                        var tempLocation = {};
                        if(JSON.stringify(result) != "{}") {
                            var pathlength = result["1152"].paths.length;
                            tempLocation = {
                                x: result["1152"].paths[pathlength - 1].x / 100 + map.minX,
                                y: map.maxY - result["1152"].paths[pathlength - 1].y / 100,
                                value: 50
                            };
                            i++;
                        }
                        hPoints.push(tempLocation);
                    },
                    error: function (msg) {
                        window.alert(msg);
                    }
                });
                $.ajax({
                    type: 'GET',
                    headers: {"api_token": api_token},
                    url: "http://track.ubitraq.com:8082/history/list?mapId=4&tagMacs%5B%5D=" + "00000273" + time,
                    async:false,
                    success: function (result) {
                        var tempLocation = {};
                        if(JSON.stringify(result) != "{}") {
                            var pathlength = result["597"].paths.length;
                            tempLocation = {
                                x: result["597"].paths[pathlength - 1].x / 100 + map.minX,
                                y: map.maxY - result["597"].paths[pathlength - 1].y / 100,
                                value: 50
                            };
                            i++;
                        }
                        hPoints.push(tempLocation);
                    },
                    error: function (msg) {
                        window.alert(msg);
                    }
                });
                $.ajax({
                    type: 'GET',
                    headers: {"api_token": api_token},
                    url: "http://track.ubitraq.com:8082/history/list?mapId=4&tagMacs%5B%5D=" + "000005e5" + time,
                    async:false,
                    success: function (result) {
                        var tempLocation = {};
                        if(JSON.stringify(result) != "{}") {
                            var pathlength = result["1153"].paths.length;
                            tempLocation = {
                                x: result["1153"].paths[pathlength - 1].x / 100 + map.minX,
                                y: map.maxY - result["1153"].paths[pathlength - 1].y / 100,
                                value: 50
                            };
                            i++;
                        }
                        hPoints.push(tempLocation);
                    },
                    error: function (msg) {
                        window.alert(msg);
                    }
                });
                $.ajax({
                    type: 'GET',
                    headers: {"api_token": api_token},
                    url: "http://track.ubitraq.com:8082/history/list?mapId=4&tagMacs%5B%5D=" + "00000267" + time,
                    async:false,
                    success: function (result) {
                        //window.alert(result.toString());
                        var tempLocation = {};
                        if(JSON.stringify(result) != "{}") {
                            var pathlength = result["595"].paths.length;
                            /*for (var i = 0; i < pathlength; i+=5) {
                            var tempLocation = {
                                x: result["101"].paths[i].x / 100 + map.minX,
                                y: map.maxY - result["101"].paths[i].y / 100,
                                value: 50
                            };
                            hPoints.push(tempLocation);
                        }*/
                            tempLocation = {
                                x: result["595"].paths[pathlength - 1].x / 100 + map.minX,
                                y: map.maxY - result["595"].paths[pathlength - 1].y / 100,
                                value: 50
                            };
                            i++;
                        }
                        hPoints.push(tempLocation);
                        console.log(2,hPoints.length);
                        console.log(1,hPoints);
                        createDtataHeatmap(map, map.focusGroupID, hPoints);
                        console.log(4,JSON.stringify(hPoints));
                        alert('当前区域有' + i + '人');
                    },
                    error: function (msg) {
                        window.alert(msg);
                    }
                });

                this.classList.add('btn-primary');
            }else {
                removeHeatmap();
                hPoints = [];
                this.classList.remove('btn-primary');
            }

            /*dataHeatmap = !dataHeatmap;
            if (dataHeatmap) {
                $.getJSON('data/heatmap.json', function(data) {
                    createDtataHeatmap(map, map.focusGroupID, data);
                });
                this.classList.add('btn-primary');
            } else {
                removeHeatmap();
                this.classList.remove('btn-primary');
            }*/
        });
    });
</script>
</body>

</html>